datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  STUDENT
  ADMIN
}

enum EmailRequestStatus {
  PENDING
  APPROVED
  REJECTED
  ISSUED
}

enum AuditAction {
  APPROVE_REQUEST
  REJECT_REQUEST
  ISSUE_EMAIL
  ADD_NOTES
}

model User {
  id                  String                 @id @default(uuid())
  name                String
  email               String                 @unique
  passwordHash        String
  role                UserRole               @default(STUDENT)
  collegeEmail        String?                @unique
  emailIssued         Boolean                @default(false)
  emailIssuedAt       DateTime?
  emailPassword       String?
  createdAt           DateTime               @default(now())
  emailRequests       EmailRequest[]
  issuedEmailHistory  IssuedEmailHistory[]
  auditLogs           AuditLog[]
}

model EmailRequest {
  id                  String              @id @default(uuid())
  studentId           String
  student             User                @relation(fields: [studentId], references: [id])
  documentURL         String
  status              EmailRequestStatus  @default(PENDING)
  extractedName       String?
  extractedRoll       String?
  extractedCollegeId  String?
  aiDecision          String?
  confidenceScore     Float?
  adminNotes          String?
  processedAt         DateTime?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @default(now()) @updatedAt
  auditLogs           AuditLog[]
}

model IssuedEmailHistory {
  id          String   @id @default(uuid())
  studentId   String
  student     User     @relation(fields: [studentId], references: [id])
  issuedEmail String
  issuedAt    DateTime @default(now())
}

model AuditLog {
  id          String      @id @default(uuid())
  adminId     String
  admin       User        @relation(fields: [adminId], references: [id])
  requestId   String
  request     EmailRequest @relation(fields: [requestId], references: [id])
  action      AuditAction
  details     String?
  createdAt   DateTime    @default(now())

  @@index([requestId])
  @@index([adminId])
  @@index([createdAt])
}
